name: Deploy To EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: 9 # ë²„ì „ì€ í”„ë¡œì íŠ¸ì— ë§ì¶° ì¡°ì •

      - name: Node ì„¤ì¹˜
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'pnpm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      # í…ŒìŠ¤íŠ¸ìš© .env ìƒì„± (ë¡œì»¬ í™˜ê²½ ë³€ìˆ˜ í•„ìš” ì‹œ)
      - name: í…ŒìŠ¤íŠ¸ìš© .env ìƒì„±
        run: |
          touch .env
          echo '${{ secrets.ENV }}' >> .env
      - name: AWS ê¶Œí•œ ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„± (Prod íƒ€ê²Ÿ ì§€ì •)
        # [ìˆ˜ì • 1] --target prod ì˜µì…˜ ì¶”ê°€: ë°°í¬ìš© ê°€ë²¼ìš´ ì´ë¯¸ì§€ë§Œ ë¹Œë“œ
        run: docker build --target prod -t one-wave-server .

      - name: Docker ì´ë¯¸ì§€ Tag ë° Push
        run: |
          docker tag one-wave-server ${{ steps.login-ecr.outputs.registry }}/one-wave-server:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/one-wave-server:latest

      - name: SSHë¡œ EC2ì— ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_CONTENT: ${{ secrets.ENV }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_USERNAME: ${{ steps.login-ecr.outputs.username }}
          ECR_PASSWORD: ${{ steps.login-ecr.outputs.password }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          # envsì— ìœ„ì—ì„œ ì„¤ì •í•œ ë³€ìˆ˜ë“¤ì„ ë“±ë¡í•´ì•¼ scriptì—ì„œ ì“¸ ìˆ˜ ìˆìŒ
          envs: ENV_CONTENT,ECR_REGISTRY,ECR_USERNAME,ECR_PASSWORD
          script_stop: true
          script: |
            echo "$ECR_PASSWORD" | docker login --username "$ECR_USERNAME" --password-stdin "$ECR_REGISTRY"
            
            echo "$ENV_CONTENT" > .env
            
            docker stop one-wave-server || true
            docker rm one-wave-server || true
            
            docker pull "$ECR_REGISTRY/one-wave-server:latest"
            
            docker run -d --name one-wave-server -p 3000:3000 --env-file .env "$ECR_REGISTRY/one-wave-server:latest"
            
            docker image prune -f
      - name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡ (ì„±ê³µ ì‹œ)
        if: success() # ìœ„ ë‹¨ê³„ë“¤ì´ ëª¨ë‘ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ ë°°í¬ ì„±ê³µ! (One Wave)"
          description: |
            **ë²„ì „:** ${{ github.sha }}
            **ë°°í¬ì:** ${{ github.actor }}
            ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.
          color: 0x00FF00 # ì´ˆë¡ìƒ‰
          url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì „ì†¡ (ì‹¤íŒ¨ ì‹œ)
        if: failure() # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í–ˆì„ ë•Œ ì‹¤í–‰
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ (One Wave)"
          description: |
            **ë°°í¬ì:** ${{ github.actor }}
            ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
          color: 0xFF0000 # ë¹¨ê°„ìƒ‰
          url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            